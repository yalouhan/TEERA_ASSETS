<!DOCTYPE html>
<html>
<head>
    <title>Keyboard Activity Record</title>
</head>
<body>
    <h2>Please input your anonymous nickname</h2>
    <input type="text" id="name" placeholder="Your name here" />
    <h2>Please Input: </h2>
    <p>The quick brown fox, jumps over the lazy dog.</p>
    <input type="text" id="inputBox" placeholder="type here" />

    <div id="log"></div>
    <button id="download">download</button>
    <button id="retry">retry</button>

    <script>
        let allSessions = []; // Array to store all session data
        let currentSession = []; // Array to store the current session data

        const inputBox = document.getElementById('inputBox');
        const nameInput = document.getElementById('name'); // Renamed variable for clarity

        inputBox.addEventListener('keydown', function(event) {
            const keyInfo = {
                key: event.key,
                type: 'keydown',
                time: Date.now()
            };

            if (event.key === ' '){
                keyInfo.key = 'space';
            }

            if (event.key === ','){
                keyInfo.key = ',';
            }

            if (event.key === 'Tab') {
                return;
            }else if(event.key === 'Enter') {
                inputBox.value = '';
                allSessions.push({ 
                sessionId: allSessions.length + 1, // Example of additional session data
                data: currentSession 
            });
                currentSession = [];
                updateLog(); // Update the log display
            }else{
                currentSession.push(keyInfo);
            }
        });

        inputBox.addEventListener('keyup', function(event) {
            const keyInfo = {
                key: event.key,
                type: 'keyup',
                time: Date.now()
            };

            if (event.key === ' '){
                keyInfo.key = 'space';
            }

            if (event.key === ','){
                keyInfo.key = ',';
            }

            if (event.key === 'Enter' || event.key === 'Tab') {
                return;
            }else{
                currentSession.push(keyInfo);
            }
            
            updateLog();
        });

        function updateLog() {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = currentSession.map(event => 
                `Key: ${event.key}, Type: ${event.type}, Time: ${event.time}`).join('<br>');
        }

        // Download logic for all session data
        document.getElementById('download').addEventListener('click', function() {
            const userName = nameInput.value; // Get the name from input
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allSessions, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", userName + "_key_events_sessions.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        // Logic for the retry button
        document.getElementById('retry').addEventListener('click', function() {
            inputBox.value = ''; // Clear the input box
            currentSession = []; // Clear the current session records
            updateLog(); // Clear the log display
        });
    </script>
</body>
</html>
